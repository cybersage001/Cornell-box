# 真实感图形渲染大作业技术报告：基于WebGL的路径追踪渲染器

## 第一章：技术背景

### 1.1 真实感渲染与全局光照的意义
真实感渲染（Photorealistic Rendering）旨在利用计算机生成与真实照片难以区分的图像。其核心在于准确模拟光线在场景中的传播行为，特别是全局光照（Global Illumination, GI）效果。全局光照不仅考虑了光源直接照射到物体表面的光（直接光照），还计算了光线在物体表面之间多次反弹后产生的间接光照。这种间接光照对于表现场景的真实感至关重要，它产生了柔和的阴影（Soft Shadows）、颜色溢出（Color Bleeding）以及环境遮蔽（Ambient Occlusion）等视觉效果，极大地增强了图像的空间感和物质感。

### 1.2 WebGL在实现并行计算渲染方面的优势
WebGL（Web Graphics Library）是一种在网页浏览器中渲染3D图形的JavaScript API，它允许开发者直接利用GPU（图形处理器）的强大并行计算能力。
*   **并行性**：路径追踪算法天然适合并行计算，因为每个像素的光线路径计算是相互独立的。WebGL的片元着色器（Fragment Shader）可以同时处理成千上万个像素，极大地加速了蒙特卡洛积分的采样过程。
*   **跨平台与零安装**：基于WebGL的渲染器可以直接在任何支持现代浏览器的设备上运行，无需用户安装额外的软件或插件，便于分享和展示。
*   **硬件加速**：通过GLSL（OpenGL Shading Language），我们可以直接编写在显卡上运行的代码，充分利用显卡的浮点运算能力。

### 1.3 路径追踪与其他渲染技术的对比
*   **光栅化（Rasterization）**：这是实时图形学（如游戏）中最常用的技术。它将几何图元投影到屏幕上，速度极快，但难以自然处理全局光照、软阴影和反射折射等复杂光效，通常需要借助Shadow Maps、SSAO等近似技术，效果往往缺乏物理准确性。
*   **Whitted风格光线追踪（Ray Tracing）**：能够处理完美的镜面反射和折射，但对于漫反射表面的间接光照处理能力有限，通常假设漫反射只受直接光照影响，导致阴影生硬，缺乏“颜色溢出”等柔和光效。
*   **路径追踪（Path Tracing）**：基于物理的渲染技术，通过求解渲染方程（Rendering Equation），利用蒙特卡洛方法随机采样光路。它能统一且物理正确地处理直接光照、间接漫反射、软阴影、焦散等所有光照现象。虽然计算成本高，但随着采样数的增加，结果会收敛至真实解。

## 第二章：技术原理与实现

### 2.1 路径追踪原理
路径追踪的核心是求解**渲染方程（The Rendering Equation）**：
$$ L_o(p, \omega_o) = L_e(p, \omega_o) + \int_{\Omega} f_r(p, \omega_i, \omega_o) L_i(p, \omega_i) (\omega_i \cdot n) d\omega_i $$
其中，$L_o$ 是出射辐射率，$L_e$ 是自发光，$f_r$ 是双向反射分布函数（BRDF），$L_i$ 是入射辐射率。

由于积分域 $\Omega$（半球空间）非常复杂，无法解析求解，我们采用**蒙特卡洛积分（Monte Carlo Integration）**。即通过随机发射大量光线，对积分进行数值估算。
对于漫反射间接光照，路径追踪通过在半球面上随机采样一个新的方向作为入射方向，递归地计算该方向传来的光线。由于光线在漫反射表面随机散射，这种方法能自然地捕捉到来自周围环境（如红墙、绿墙）的反射光，从而形成颜色溢出效果。

### 2.2 WebGL实现策略：渐进式渲染
由于路径追踪计算量巨大，单帧完成数千次采样在浏览器中是不现实的。我们采用**渐进式渲染（Progressive Rendering）**策略：
1.  **并行计算**：利用WebGL片元着色器，为屏幕上的每个像素分配一个线程。每个线程发射一条光线，进行少量的反弹计算（如8次），得到一个高噪声的样本值。
2.  **乒乓缓冲区（Ping-Pong Buffers）**：使用两个浮点纹理（Texture A 和 Texture B）作为帧缓冲区。
    *   第N帧：读取Texture A（包含前N-1帧的累积结果），将当前帧计算的新样本与Texture A混合，写入Texture B。
    *   第N+1帧：读取Texture B，混合新样本，写入Texture A。
3.  **混合公式**：$Color_{avg} = \text{mix}(Color_{prev}, Color_{new}, \frac{1}{FrameCount})$。随着帧数增加，噪声（方差）以 $1/\sqrt{N}$ 的速度降低，图像逐渐清晰。

### 2.3 场景定义与射线相交
在片元着色器中，由于无法像CPU那样灵活使用多态对象，我们使用结构体（Struct）和数组来定义场景。
*   **几何定义**：定义了 `Sphere`（球体）和 `Box`（轴对齐包围盒 AABB）结构体。
*   **求交计算**：
    *   **射线-球体相交**：求解二次方程 $|O + tD - C|^2 = R^2$。
    *   **射线-包围盒相交**：采用“Slab Method”，计算射线进入和离开三个轴向平面的 $t_{min}$ 和 $t_{max}$，取交集判断是否击中。
*   **场景遍历**：`intersectScene` 函数遍历场景中所有物体，返回最近的交点信息（距离 $t$、法线 $n$、材质ID）。

### 2.4 关键实现细节
*   **下一事件估计（Next Event Estimation, NEE）**：为了解决传统路径追踪在小光源下收敛慢、噪点多（Fireflies）的问题，我们实现了显式光源采样。在每次光线反弹时，除了随机采样间接光，还直接向光源发射一条“阴影光线”（Shadow Ray）。如果该光线未被遮挡，则直接计算光源对当前点的贡献。这极大地提高了采样效率，使得阴影和直接光照能迅速收敛。
*   **随机数生成**：GLSL没有内置随机函数。我们实现了一个基于正弦和哈希算法的伪随机数生成器（Jenkins Hash），利用像素坐标 `vUv` 和时间 `uSeed` 作为种子，确保每个像素每帧的随机数序列不同。
*   **俄罗斯轮盘赌（Russian Roulette）**：为了无偏地终止无限递归的光路，当路径深度超过一定阈值（如3次反弹）后，以概率 $P$ 终止路径，否则将光线能量除以 $1-P$ 进行补偿。这保证了能量守恒并提高了渲染效率。
*   **色调映射与伽马校正**：路径追踪计算的是线性空间的辐射率（Radiance），数值范围可能远超显示器显示的 [0, 1]。
    *   **Reinhard Tone Mapping**：$C_{out} = C_{in} / (C_{in} + 1)$，将高动态范围（HDR）映射到低动态范围（LDR）。
    *   **Gamma校正**：$C_{final} = C_{out}^{1/2.2}$，将线性颜色转换到sRGB空间，以符合人眼对亮度的非线性感知。

## 第三章：代码结构与实验结果

### 3.1 代码结构说明
项目采用 React + TypeScript + Three.js 架构，实现了模块化开发。
*   `src/components/PathTracer/PathTracer.tsx`：核心组件。负责初始化WebGL上下文、管理Ping-Pong缓冲区、处理相机交互（OrbitControls）以及渲染循环。
*   `src/components/PathTracer/shaders/PathTracingShader.ts`：核心算法。包含顶点着色器和片元着色器。片元着色器实现了 `trace()` 函数、场景定义（Cornell Box）、材质系统（Lambertian, Mirror）、NEE采样和随机采样。
*   `src/components/PathTracer/shaders/ScreenShader.ts`：后处理着色器。负责将累积缓冲区的HDR数据进行色调映射和Gamma校正后输出到屏幕。

### 3.2 实验结果与分析
*   **场景展示**：成功渲染了经典的Cornell Box场景。左墙为红色，右墙为绿色，天花板有面光源。场景中包含一个漫反射的长方体和一个类镜面的长方体（或球体）。
*   **收敛性分析**：
    *   **1帧**：由于引入了NEE，即使在第1帧，场景的直接光照和阴影也已基本清晰，仅间接光照部分存在噪点。
    *   **10帧**：噪点明显减少，软阴影非常柔和，颜色溢出效果开始显现。
    *   **100帧**：图像基本平滑，高频噪声几乎消失。
    *   **1000帧**：图像非常细腻，接近真实照片级质量。
*   **参数影响**：
    *   **最大路径长度**：设置为8次反弹。若减少反弹次数（如2次），暗部（如墙角）会变得过暗，且颜色溢出效果减弱，说明间接光照贡献不足。
    *   **材质**：漫反射材质展现了均匀的亮度分布；镜面材质清晰地反射了周围环境，且在镜面反射中也能观察到正确的全局光照效果。

## 第四章：总结与展望

### 4.1 总结
本项目成功基于WebGL实现了一个运行在浏览器中的路径追踪渲染器。
1.  利用片元着色器实现了并行的蒙特卡洛路径追踪算法。
2.  通过Ping-Pong缓冲区技术实现了渐进式渲染，有效解决了实时计算量不足的问题。
3.  **引入了下一事件估计（NEE）技术**，显著提升了渲染收敛速度，解决了画面过暗和噪点过多的问题。
4.  复现了Cornell Box经典场景，展示了软阴影、颜色溢出和镜面反射等高级光照效果。
5.  提供了交互式漫游功能，增强了演示效果。

遇到的挑战主要在于GLSL的调试困难以及浮点数精度问题。在早期开发中，随机数生成器的质量直接影响了噪点的分布模式。

### 4.2 展望
*   **加速结构**：目前采用线性遍历场景物体，复杂度为O(N)。对于复杂模型，应引入BVH（包围体层次结构）或KD-Tree，并将树结构打包到纹理中供着色器访问，以将求交复杂度降至O(logN)。
*   **更复杂的材质**：实现折射（玻璃、水）、次表面散射（皮肤、玉石）以及微表面模型（Microfacet BRDF）以支持粗糙金属等材质。
*   **降噪算法**：引入AI降噪（如Intel OIDN的Web版）或基于着色器的双边滤波，在低采样数下快速获得平滑图像。
*   **景深与运动模糊**：在相机模型中引入透镜半径和时间维度，模拟真实相机的物理缺陷美感。
